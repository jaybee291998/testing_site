{% extends 'base.html' %}
{% block title %}
	List App
{% endblock %}
{% block content %}
	<div id="create-update-div">
		<h1>Create</h1>
		<label for="name">Name:</label>
		<input type="text" name="title" maxlength="64" required id="name">
		<br>
		<textarea id="content-textarea">
			hi
		</textarea>
		<button id="post-btn">Post</button>
		<button id="update-btn">Update</button>
		<button id="delete-btn">Delete</button>
		<button id="back-btn">Back</button>
	</div>

	<div id="list-div">
		<h1>List</h1>
		<input type="text" name="search-bar" id="search-bar" placeholder="search">
		<div id="table-div">
		</div>
		<button id="create-btn">create</button>
	</div>

	<div id="detail-div">

	</div>

	<div id="delete-div">
		<h1>Delete</h1>
	</div>
	{% load static %}
	<script src="https://cdn.tiny.cloud/1/u9jme0ubzunc1ikuzefidbdc7pnodyglzq5mnqh5tkss5lui/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
	<script type="text/javascript" src="{% static 'js/ui.js' %}"></script>
	<script type="text/javascript" src="{% static 'js/api.js' %}"></script>
	<script type="text/javascript">
// initialize tiny mce
		tinymce.init({
		    selector: '#content-textarea',
			plugins: '',
			toolbar: 'a11ycheck addcomment showcomments casechange checklist code export formatpainter pageembed permanentpen table',
			toolbar_mode: 'floating', 
			tinycomments_mode: 'embedded',
			tinycomments_author: 'Author name', 
		});
		const post_domain = '{{list_api}}';
		const detail_domain = '{{detail_api}}';

		let raw_data = null;
		let selected_index = null;

		const createUpdateDiv = document.getElementById('create-update-div');
		const listDiv = document.getElementById('list-div');
		const detailDiv = document.getElementById('detail-div');
		const updateDiv = document.getElementById('update-div');
		const deleteDiv = document.getElementById('delete-div');
		const tableDiv = document.getElementById('table-div');

		const divList = [createUpdateDiv, listDiv, detailDiv, deleteDiv];

		const nameInput = document.getElementById('name');

		// buttons 
		const postBtn = document.getElementById('post-btn');
		const updateBtn = document.getElementById('update-btn');
		const deleteBtn = document.getElementById('delete-btn');
		const backBtn = document.getElementById('back-btn');
		const createBtn = document.getElementById('create-btn');

		// bind buttons to certain actions
		postBtn.onclick = postAction;
		updateBtn.onclick = updateAction;
		backBtn.onclick = displayList;
		createBtn.onclick = displayCreate;
		deleteBtn.onclick = deleteAction;

		function showDiv(div_to_show){
			return showDivBase(div_to_show, divList);
		}

		// get the data from the form
		// return a dictionary that contains the label and value
		function getFormData(){
			const data = {
				name: nameInput.value,
				content: tinymce.get('content-textarea').getContent()
			}
			return data;
		}

		// set the content of the form
		function setFormData(name, content){
			nameInput.value = name;
			tinymce.get('content-textarea').setContent(content)
		}

		// just a wrapper that uses the setFormData to clear the form
		function clearForm(){
			setFormData('', '');
		}

		async function postAction(e){
			const formData = getFormData();
			const data = await post(formData);
			clearForm();

			// add the new element to the raw data
			raw_data.push(data);
			console.log(raw_data);
			displayList();
		}

		async function updateAction(e){
			const formData = getFormData();
			const data = await update(formData, raw_data[selected_index]['id']);
			clearForm();

			// update the raw data of the changes
			raw_data[selected_index]['name'] = formData['name'];
			raw_data[selected_index]['content'] = formData['content'];

			console.log(raw_data);
			displayList();
		}

		async function deleteAction(e){
			const res = await del_(raw_data[selected_index]['id']);

			// remove the element from the raw_data
			delete raw_data[selected_index];

			console.log(raw_data);

			displayList();
		}

		// wrapper for post
		async function post(formData){
			return await post_update(post_domain, 'POST', formData, getCookie('csrftoken'));
		}

		async function update(formData, pk){
			return await post_update(`${detail_domain}/${pk}/`, 'PUT', formData, getCookie('csrftoken'));
		}

		async function del_(pk){
			return await del(`${detail_domain}/${pk}/`, getCookie('csrftoken'));
		}

		// initialize the app
		async function init(){
			// get the data and set the raw_data variable
			raw_data = await get_data(post_domain);
			// display the list
			displayList();

		}

		function row_selection_function(e){
			selected_index = e.srcElement.parentNode.id;
			const selected_data = raw_data[selected_index];
			console.log(`selected_index: ${selected_index}`);
			displayDetail(selected_data);
		}
		// for display
		async function displayList(){
			showDiv(listDiv);
			const data = await get_data(post_domain);
			console.log(`from server: ${data}`);
			const properties_to_show = ['name', 'last_modified', 'timestamp'];
			const titles = ['Name', 'Last Modified', 'Date'];
			const table = createTable(data, properties_to_show, row_selection_function, 'table', titles);

			// display the table
			tableDiv.innerHTML = '';
			tableDiv.appendChild(table);
		}

		function displayDetail(selected_data){
			// this should be the detailDiv
			// but since we are using a wysiwyg it makes send to use it to also display the details
			// since only the editor can display the content
			showDiv(createUpdateDiv);
			setFormData(selected_data['name'], selected_data['content']);

			// display necessary buttons
			updateBtn.style.display = 'block';
			deleteBtn.style.display = 'block';
			backBtn.style.display = 'block';

			// hide post btn
			postBtn.style.display = 'none';

		}

		function displayCreate(){
			showDiv(createUpdateDiv);
			clearForm();

			// show necessary buttons
			postBtn.style.display = 'block';
			backBtn.style.display = 'block';

			// hide unnecessary buttons
			updateBtn.style.display = 'none';
			deleteBtn.style.display = 'none';

		}

		function createDetailFields(){

		}

		function createDetailField(label, value){
			const p = document.createElement('P');
			p.textContent = `${label}: ${value}`;
			return p;
		}

		init();
	</script>
{% endblock %}